<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <meta name="HandheldFriendly" content="true"/>
        <meta name="MobileOptimized" content="320"/>
        <title>Hello H5+</title>
        <script type="text/javascript" src="js/common.js"></script>
        <link rel="stylesheet" href="css/mui.min.css">
        <style>
            header#header {
                position: relative;
            }
            .mui-icon-loop{
                line-height: 44px;
            }
            .mui-btn-primary{
                position:absolute;
                right:10px;
            }
            button.mui-btn.mui-btn-primary {
                top: 5px;
            }
            table{border-right:1px solid #2196F3;border-bottom:1px solid #2196F3}
            table td{border-left:1px solid #2196F3;border-top:1px solid #2196F3;text-align: center;}
        </style>
        
        <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8"/>
    </head>
    <body>
        <header id="header">
            <div class="nvbt iback" onclick="plus.runtime.quit()"></div>
            <div class="nvtt">小猪巴士</div>
            <div class="mui-icon mui-icon-loop" onclick="xhrCreate();"></div>
        </header>
        
        <div class="mui-card">
            <div class="mui-card-content">
                <div id="time" class="mui-card-content-inner"></div>
            </div>
        </div>
        
        <div class="mui-card">
            <div class="mui-card-content">
                <div class="mui-card-header">账户信息:</div>
                <div id="acc" class="mui-card-content-inner"></div>
            </div>
        </div>
        
        <div class="mui-card git-card">
            <div class="mui-card-content">
                <div id="number" class="mui-card-header">获取号码:<button type="button" class="mui-btn mui-btn-primary" onclick="getNumber();">获取</button></div>
                <div id="myNumber" class="mui-card-content-inner"></div>
            </div>
        </div>
        
        <div class="mui-card">
            <div class="mui-card-content">
                <div class="mui-card-header">快速充值:</div>
                <form class="mui-input-group">
                    <div class="mui-button-row">
                        <input id="put" type="text" placeholder="输入订单号">
                        <button type="button" class="mui-btn mui-btn-primary" onclick="recharge();">充值</button>
                    </div>
                </form>
            </div>
        </div>
        
    </body>
    <script type="text/javascript" src="js/immersed.js" ></script>
    <script type="text/javascript" src="js/owo.js"></script>
    <script type="text/javascript">
        
        xhrCreate();
        var token=null,number=null,time=0;
        function cutString(original,before,after,index){index = index || 0;if (typeof index === "number") {const P = original.indexOf(before, index);if (P > -1) {if (after) {const f = original.indexOf(after, P + 1);return (f>-1)? original.slice(P + before.toString().length, f):console.error("owo [在文本中找不到 参数三 "+after+"]");} else {return original.slice(P + before.toString().length);}} else {console.error("owo [在文本中找不到 参数一 " + before + "]");}} else {console.error("owo [sizeTransition:" + index + "不是一个整数!]");}
        }
    function getMyNumber()
    {
        const url=`http://api.shjmpt.com:9002/pubApi/GMessage?token=${token}&ItemId=2200&Phone=${number}`;
        const xhr = new plus.net.XMLHttpRequest();
        xhr.onload = function () {
            if ( xhr.status == 200 ) {
                const myNumber = document.getElementById("myNumber");
                time++;
                if(time>20){
                    myNumber.innerHTML=`尝试20次失败，自动停止！`;
                }
                else{
                    myNumber.innerHTML=`第${time}次获取:${xhr.responseText}`;
                    if(xhr.responseText.indexOf("False")!==-1){
                        setTimeout("getMyNumber()",5000);
                    }
                    else{
                        time=0;
                    }
                }
                
            }
            else{
                alert( "xhr请求失败："+xhr.status );
            }
        }
        xhr.open( "GET", url );
        xhr.send();
    }
    
    function getNumber(){
        if(token===null){
            alert("Token为null");
        }
        else{
            const url=`http://api.shjmpt.com:9002/pubApi/GetPhone?ItemId=2200&token=${token}`;
            const xhr = new plus.net.XMLHttpRequest();
            xhr.onload = function () {
                if ( xhr.status == 200 ) {
                    const acc = document.getElementById("number");
                    number =xhr.responseText.split(";")[0];
                    acc.innerHTML=number;
                    setTimeout("getMyNumber()",500);                    
                }
                else{
                    alert( "xhr请求失败："+xhr.status );
                }
            }
            xhr.open( "GET", url );
            xhr.send();
        }
        
    }
    function recharge(){
        var re = document.getElementById("put");
        const xhr=new plus.net.XMLHttpRequest();
        xhr.open( "POST", "http://shjmpt.com:8000/userManage/Api.aspx" );
        xhr.onload=function(){
            alert(xhr.responseText);
        }
        let data=`tradeNo=${re.value}&userName=pandelion`;
        xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
        // 发送HTTP请求
        xhr.send(data);
    }
    

    function xhrCreate() {
        const url="http://api.shjmpt.com:9002/pubApi/uLogin?uName=pandelion&pWord=mmit7750&Developer=Y1ywdDJCpG3BO2s4VzN7Zw%3d%3d";
        const xhr = new plus.net.XMLHttpRequest();
        xhr.onload = function () {
            if ( xhr.status == 200 ) {
                const acc = document.getElementById("acc");
                const information =xhr.responseText.split("&");
                acc.innerHTML=`折扣:${information[5]}折。<br/>账户余额:${information[1]}元。<br/>最多获取号码数:${information[3]}个。<br/>最大登录客户端个数:${information[2]}个。<br/>单个客户端最多获取号码数:${information[4]}个。<br/>key:${information[0]}<br/>`;
                const myDate = new Date();
                const time = document.getElementById("time");
                time.innerHTML=`更新时间:${myDate.toLocaleString()}`;
                token=information[0];
            } else {
                alert( "xhr请求失败："+xhr.status );
            }
        }
        xhr.open( "GET", url );
        xhr.send();
    }
    </script>
</html>
